import { useState } from "react";
import { useMutation, useQuery } from "@tanstack/react-query";
import { apiRequest, queryClient } from "@/lib/queryClient";
import { useToast } from "@/hooks/use-toast";
import { useAuth } from "@/hooks/useAuth";
import { isUnauthorizedError } from "@/lib/authUtils";
import { Button } from "@/components/ui/button";
import { Input } from "@/components/ui/input";
import { Card, CardContent } from "@/components/ui/card";
import { RadioGroup, RadioGroupItem } from "@/components/ui/radio-group";
import { Label } from "@/components/ui/label";
import { Progress } from "@/components/ui/progress";
import { 
  KeyRound, 
  Bot, 
  User, 
  ChartLine,
  List,
  Thermometer,
  Home,
  Bus,
  UserIcon,
  Dice1,
  SlidersHorizontal,
  Bookmark,
  Copy,
  RefreshCw,
  Edit,
  Lightbulb,
  Send,
  Shield,
  RotateCcw,
  LogIn,
  LogOut,
  UserCheck
} from "lucide-react";
import { ChatMessage } from "@/components/ui/chat-message";
import { CategorySelector } from "@/components/ui/category-selector";
import { ExcuseCard } from "@/components/ui/excuse-card";
import { UsageStatus } from "@/components/ui/usage-status";
import { SavedExcuses } from "@/components/ui/saved-excuses";
import type { ExcuseRequest, ExcuseResponse } from "@shared/schema";

export default function HomePage() {
  const { toast } = useToast();
  const { user, isAuthenticated } = useAuth();
  const [selectedCategory, setSelectedCategory] = useState<string>("health");
  const [selectedTone, setSelectedTone] = useState<string>("light");
  const [userInput, setUserInput] = useState("");
  const [currentExcuse, setCurrentExcuse] = useState<ExcuseResponse | null>(null);
  const [messages, setMessages] = useState<Array<{
    type: 'bot' | 'user';
    content: string;
    excuse?: ExcuseResponse;
  }>>([
    {
      type: 'bot',
      content: 'ÏïàÎÖïÌïòÏÑ∏Ïöî! üëã ExcuseMeÏûÖÎãàÎã§. Ïñ¥Îñ§ ÏÉÅÌô©ÏóêÏÑú ÏàòÏóÖÏùÑ Îπ†Ï†∏Ïïº ÌïòÏãúÎÇòÏöî? ÏÉÅÌô©ÏùÑ ÏÑ†ÌÉùÌïòÏãúÍ±∞ÎÇò Íµ¨Ï≤¥Ï†ÅÏúºÎ°ú ÎßêÏîÄÌï¥ Ï£ºÏÑ∏Ïöî!'
    }
  ]);

  const { data: usageStats } = useQuery({
    queryKey: ['/api/usage/current-week'],
  });

  const { data: bookmarkedExcuses } = useQuery({
    queryKey: ['/api/excuses/bookmarked'],
  });

  const generateExcuseMutation = useMutation({
    mutationFn: async (request: ExcuseRequest) => {
      const response = await apiRequest('POST', '/api/generate-excuse', request);
      return response.json();
    },
    onSuccess: (data: ExcuseResponse) => {
      setCurrentExcuse(data);
      setMessages(prev => [
        ...prev,
        {
          type: 'bot',
          content: `${getCategoryName(data.category)} Í¥ÄÎ†® ÌïëÍ≥ÑÎ•º ÏÉùÏÑ±ÌñàÏñ¥Ïöî! ÏûêÏó∞Ïä§ÎüΩÍ≤å ÏÇ¨Ïö©Ìï¥ Î≥¥ÏÑ∏Ïöî üòä`,
          excuse: data
        }
      ]);
      queryClient.invalidateQueries({ queryKey: ['/api/usage/current-week'] });
    },
    onError: () => {
      toast({
        title: "Ïò§Î•ò",
        description: "ÌïëÍ≥Ñ ÏÉùÏÑ±Ïóê Ïã§Ìå®ÌñàÏäµÎãàÎã§. Îã§Ïãú ÏãúÎèÑÌï¥Ï£ºÏÑ∏Ïöî.",
        variant: "destructive"
      });
    }
  });

  const bookmarkMutation = useMutation({
    mutationFn: async ({ id, bookmarked }: { id: number; bookmarked: boolean }) => {
      const response = await apiRequest('PATCH', `/api/excuses/${id}/bookmark`, { bookmarked });
      return response.json();
    },
    onSuccess: () => {
      toast({
        title: "ÏÑ±Í≥µ",
        description: "ÌïëÍ≥ÑÍ∞Ä Ï†ÄÏû•ÎêòÏóàÏäµÎãàÎã§!"
      });
      queryClient.invalidateQueries({ queryKey: ['/api/excuses/bookmarked'] });
    }
  });

  const clearExcusesMutation = useMutation({
    mutationFn: async () => {
      const response = await apiRequest('DELETE', '/api/excuses/clear');
      return response.json();
    },
    onSuccess: () => {
      toast({
        title: "Ï¥àÍ∏∞Ìôî ÏôÑÎ£å",
        description: "ÌïëÍ≥Ñ Í∏∞Î°ùÏù¥ Î™®Îëê ÏÇ≠Ï†úÎêòÏóàÏäµÎãàÎã§."
      });
      queryClient.invalidateQueries({ queryKey: ['/api/excuses/bookmarked'] });
      queryClient.invalidateQueries({ queryKey: ['/api/usage/current-week'] });
      setMessages([{
        type: 'bot',
        content: 'ÏïàÎÖïÌïòÏÑ∏Ïöî! üëã ExcuseMeÏûÖÎãàÎã§. Ïñ¥Îñ§ ÏÉÅÌô©ÏóêÏÑú ÏàòÏóÖÏùÑ Îπ†Ï†∏Ïïº ÌïòÏãúÎÇòÏöî? ÏÉÅÌô©ÏùÑ ÏÑ†ÌÉùÌïòÏãúÍ±∞ÎÇò Íµ¨Ï≤¥Ï†ÅÏúºÎ°ú ÎßêÏîÄÌï¥ Ï£ºÏÑ∏Ïöî!'
      }]);
      setCurrentExcuse(null);
    },
    onError: () => {
      toast({
        title: "Ïò§Î•ò",
        description: "Ï¥àÍ∏∞ÌôîÏóê Ïã§Ìå®ÌñàÏäµÎãàÎã§. Îã§Ïãú ÏãúÎèÑÌï¥Ï£ºÏÑ∏Ïöî.",
        variant: "destructive"
      });
    }
  });

  const handleGenerateExcuse = () => {
    if (!userInput.trim()) {
      toast({
        title: "ÏûÖÎ†• ÌïÑÏöî",
        description: "Íµ¨Ï≤¥Ï†ÅÏù∏ ÏÉÅÌô©ÏùÑ ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî.",
        variant: "destructive"
      });
      return;
    }

    const userMessage = userInput;
    setMessages(prev => [...prev, {
      type: 'user',
      content: userMessage
    }]);

    generateExcuseMutation.mutate({
      category: selectedCategory as any,
      tone: selectedTone as any,
      userInput: userMessage
    });

    setUserInput("");
  };

  const handleCopyExcuse = (content: string) => {
    navigator.clipboard.writeText(content);
    toast({
      title: "Î≥µÏÇ¨ ÏôÑÎ£å",
      description: "ÌïëÍ≥ÑÍ∞Ä ÌÅ¥Î¶ΩÎ≥¥ÎìúÏóê Î≥µÏÇ¨ÎêòÏóàÏäµÎãàÎã§!"
    });
  };

  const handleSaveExcuse = (excuse: ExcuseResponse) => {
    bookmarkMutation.mutate({ id: excuse.id, bookmarked: true });
  };

  const handleRegenerateExcuse = () => {
    if (currentExcuse) {
      generateExcuseMutation.mutate({
        category: selectedCategory as any,
        tone: selectedTone as any,
        userInput: "Îã§Ïãú ÏÉùÏÑ±Ìï¥Ï£ºÏÑ∏Ïöî"
      });
    }
  };

  const getCategoryName = (category: string): string => {
    const names = {
      health: "Î™∏ ÏÉÅÌÉú",
      family: "Í∞ÄÏ°± Î¨∏Ï†ú", 
      transport: "ÍµêÌÜµ Î¨∏Ï†ú",
      personal: "Í∞úÏù∏ ÏÇ¨Ï†ï"
    };
    return names[category as keyof typeof names] || category;
  };

  const getToneName = (tone: string): string => {
    const names = {
      light: "Í∞ÄÎ≤ºÏö¥",
      moderate: "Ï†ÅÎãπÌïú",
      serious: "ÏßÑÏßÄÌïú"
    };
    return names[tone as keyof typeof names] || tone;
  };

  return (
    <div className="bg-cream min-h-screen">
      {/* Header */}
      <header className="bg-white shadow-sm border-b border-gray-200">
        <div className="max-w-6xl mx-auto px-4 py-4 flex items-center justify-between">
          <div className="flex items-center space-x-3">
            <div className="w-10 h-10 bg-[var(--lavender)] rounded-full flex items-center justify-center">
              <KeyRound className="text-white" size={20} />
            </div>
            <div>
              <h1 className="text-xl font-bold text-[var(--navy)]">ExcuseMe</h1>
              <p className="text-sm text-gray-500">ÎãπÏã†Ïùò ÏûëÏùÄ ÎπÑÎ∞Ä ÏπúÍµ¨</p>
            </div>
          </div>
          <div className="flex items-center space-x-2">
            <Button 
              variant="ghost" 
              size="icon" 
              className="rounded-full hover:bg-[var(--lavender)]/10"
              onClick={() => clearExcusesMutation.mutate()}
              disabled={clearExcusesMutation.isPending}
              title="Ï¥àÍ∏∞Ìôî"
            >
              <RotateCcw className="text-[var(--lavender)]" size={20} />
            </Button>
            {isAuthenticated ? (
              <div className="flex items-center space-x-2">
                <div className="text-xs text-gray-600 flex items-center space-x-1">
                  <UserCheck className="h-3 w-3" />
                  <span>{user?.email || "Î°úÍ∑∏Ïù∏Îê®"}</span>
                </div>
                <Button 
                  variant="ghost" 
                  size="icon" 
                  className="rounded-full hover:bg-[var(--lavender)]/10"
                  onClick={async () => {
                    try {
                      await apiRequest('POST', '/api/auth/logout');
                      queryClient.clear();
                      toast({
                        title: "Î°úÍ∑∏ÏïÑÏõÉ ÏôÑÎ£å",
                        description: "ÏÑ±Í≥µÏ†ÅÏúºÎ°ú Î°úÍ∑∏ÏïÑÏõÉÎêòÏóàÏäµÎãàÎã§."
                      });
                      // Î°úÍ∑∏ÏïÑÏõÉ ÌõÑ Ï¶âÏãú Î°úÍ∑∏Ïù∏ Ï†Ñ ÏÉÅÌÉúÎ°ú Î≥ÄÍ≤Ω
                      window.location.reload();
                    } catch (error) {
                      toast({
                        title: "Î°úÍ∑∏ÏïÑÏõÉ Ïã§Ìå®",
                        description: "Î°úÍ∑∏ÏïÑÏõÉ Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.",
                        variant: "destructive"
                      });
                    }
                  }}
                  title="Î°úÍ∑∏ÏïÑÏõÉ"
                >
                  <LogOut className="text-[var(--lavender)]" size={20} />
                </Button>
              </div>
            ) : (
              <Button 
                variant="ghost" 
                size="icon" 
                className="rounded-full hover:bg-[var(--lavender)]/10"
                onClick={() => window.location.href = '/api/login'}
                title="Î°úÍ∑∏Ïù∏"
              >
                <LogIn className="text-[var(--lavender)]" size={20} />
              </Button>
            )}
          </div>
        </div>
      </header>

      <div className="max-w-6xl mx-auto px-4 py-6 flex flex-col lg:flex-row gap-6">
        {/* Sidebar */}
        <div className="lg:w-80 space-y-6">
          <UsageStatus stats={usageStats} />
          
          <CategorySelector 
            selectedCategory={selectedCategory}
            onCategoryChange={setSelectedCategory}
          />

          {/* Tone Control */}
          <Card className="shadow-sm border border-gray-200">
            <CardContent className="p-5">
              <h3 className="font-semibold text-[var(--navy)] mb-4 flex items-center">
                <SlidersHorizontal className="text-[var(--lavender)] mr-2" size={18} />
                ÌÜ§ Ï°∞Ï†à
              </h3>
              <RadioGroup value={selectedTone} onValueChange={setSelectedTone} className="space-y-3">
                <div className="flex items-center space-x-3">
                  <RadioGroupItem value="light" id="light" className="text-[var(--lavender)] border-[var(--lavender)]" />
                  <Label htmlFor="light" className="text-sm text-[var(--navy)] cursor-pointer">Í∞ÄÎ≤ºÏö¥ ÌïëÍ≥Ñ</Label>
                </div>
                <div className="flex items-center space-x-3">
                  <RadioGroupItem value="moderate" id="moderate" className="text-[var(--lavender)] border-[var(--lavender)]" />
                  <Label htmlFor="moderate" className="text-sm text-[var(--navy)] cursor-pointer">Ï†ÅÎãπÌïú ÏÇ¨Ïú†</Label>
                </div>
                <div className="flex items-center space-x-3">
                  <RadioGroupItem value="serious" id="serious" className="text-[var(--lavender)] border-[var(--lavender)]" />
                  <Label htmlFor="serious" className="text-sm text-[var(--navy)] cursor-pointer">ÏßÑÏßÄÌïú ÏÇ¨Ïú†</Label>
                </div>
              </RadioGroup>
            </CardContent>
          </Card>

          <SavedExcuses excuses={bookmarkedExcuses || []} onCopyExcuse={handleCopyExcuse} />
        </div>

        {/* Main Chat Area */}
        <div className="flex-1 flex flex-col">
          {/* Chat Messages */}
          <Card className="shadow-sm border border-gray-200 flex-1 mb-4">
            <CardContent className="p-6">
              <div className="space-y-4 mb-6 max-h-96 overflow-y-auto">
                {messages.map((message, index) => (
                  <ChatMessage 
                    key={index}
                    type={message.type}
                    content={message.content}
                    excuse={message.excuse}
                    onCopy={handleCopyExcuse}
                    onSave={handleSaveExcuse}
                    onRegenerate={handleRegenerateExcuse}
                    isGenerating={generateExcuseMutation.isPending}
                  />
                ))}

                {/* Tips Message */}
                <div className="flex items-start space-x-3">
                  <div className="w-8 h-8 bg-[var(--lavender)] rounded-full flex items-center justify-center flex-shrink-0">
                    <Lightbulb className="text-white" size={16} />
                  </div>
                  <div className="bg-yellow-50 border border-yellow-200 rounded-2xl rounded-tl-md p-4 max-w-md">
                    <p className="text-sm text-yellow-800">
                      <strong>üí° ÏÇ¨Ïö© ÌåÅ:</strong> Í∞ôÏùÄ ÌïëÍ≥ÑÎ•º ÎÑàÎ¨¥ ÏûêÏ£º ÏÇ¨Ïö©ÌïòÏßÄ ÎßàÏÑ∏Ïöî. Îã§ÏñëÌïú ÏÉÅÌô©ÏùÑ Î≤àÍ∞àÏïÑ ÏÇ¨Ïö©ÌïòÎäî Í≤ÉÏù¥ Ï¢ãÏïÑÏöî!
                    </p>
                  </div>
                </div>
              </div>
            </CardContent>
          </Card>

          {/* Input Area */}
          <Card className="shadow-sm border border-gray-200">
            <CardContent className="p-4">
              <div className="flex space-x-3">
                <Input
                  value={userInput}
                  onChange={(e) => setUserInput(e.target.value)}
                  placeholder="Íµ¨Ï≤¥Ï†ÅÏù∏ ÏÉÅÌô©ÏùÑ ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî... (Ïòà: ÎÇ¥Ïùº 3ÍµêÏãú ÏòÅÏñ¥ ÏàòÏóÖ)"
                  className="flex-1 border-gray-200 focus:border-[var(--lavender)] focus:ring-[var(--lavender)]/20"
                  onKeyPress={(e) => e.key === 'Enter' && handleGenerateExcuse()}
                />
                <Button 
                  onClick={handleGenerateExcuse}
                  disabled={generateExcuseMutation.isPending || !userInput.trim()}
                  className="bg-[var(--lavender)] hover:bg-[var(--lavender)]/90 text-white"
                >
                  <Send size={16} />
                </Button>
              </div>
              <div className="flex items-center justify-between mt-3 text-xs text-gray-500">
                <span>AIÍ∞Ä ÏÉÅÌô©Ïóê ÎßûÎäî ÏûêÏó∞Ïä§Îü¨Ïö¥ ÌïëÍ≥ÑÎ•º ÏÉùÏÑ±Ìï¥ÎìúÎ†§Ïöî</span>
                <span className="flex items-center space-x-1">
                  <Shield className="text-[var(--lavender)]" size={12} />
                  <span>ÏïàÏ†ÑÌïú ÏÇ¨Ïö©</span>
                </span>
              </div>
            </CardContent>
          </Card>
        </div>
      </div>
    </div>
  );
}
